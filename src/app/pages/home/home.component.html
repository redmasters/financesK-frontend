<!-- Main Content -->
<div class="main-content">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title clickable-title" (click)="navigateToHome()">Controle Financeiro</h1>
      <p class="page-subtitle">Gerencie suas finanças de forma inteligente</p>
    </div>
    <div class="header-right">
      <div class="header-controls">
        <!-- Dropdown de Adicionar Transação -->
        <div class="add-transaction-dropdown">
          <button class="btn-action btn-add" (click)="toggleAddDropdown()" [class.active]="showAddDropdown">
            <i class="fas fa-plus"></i>
            Adicionar
            <i class="fas fa-chevron-down dropdown-arrow" [class.rotated]="showAddDropdown"></i>
          </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu" *ngIf="showAddDropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-item income-item" (click)="openIncomeModal()">
              <i class="fas fa-plus-circle"></i>
              <span>Nova Receita</span>
            </button>
            <button class="dropdown-item expense-item" (click)="openExpenseModal()">
              <i class="fas fa-minus-circle"></i>
              <span>Nova Despesa</span>
            </button>
          </div>
        </div>

        <!-- Botão de Privacidade -->
        <button class="privacy-btn" (click)="toggleValueVisibility()" [title]="showValues ? 'Ocultar valores' : 'Mostrar valores'">
          <i class="fas" [class.fa-eye]="showValues" [class.fa-eye-slash]="!showValues"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Dashboard Cards -->
  <div class="dashboard-grid">
    <!-- Saldo Principal (Card Grande) -->
    <div class="balance-card-main">
      <div class="balance-header">
        <div class="balance-info">
          <div class="balance-title">SALDO DO MÊS</div>
          <div class="balance-value" [class.positive]="financialData.balance > 0"
               [class.negative]="financialData.balance < 0">
            {{ getDisplayValue(financialData.balanceFormatted) }}
          </div>
          <div class="balance-subtitle">Atualizado em {{ getCurrentDate() }}</div>
        </div>
      </div>
      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getMonthProgress()"></div>
        </div>
        <div class="progress-text">
          {{ getMonthProgress().toFixed(0) }}% do mês decorrido
        </div>
      </div>
    </div>

    <!-- Cards Menores -->
    <div class="info-card income-card">
      <div class="card-icon bg-success-light">
        <i class="fas fa-money-check"></i>
      </div>
      <div class="card-content">
        <div class="card-title">ENTRADAS</div>
        <div class="card-value">{{ getDisplayValue(financialData.totalIncomeFormatted) }}</div>
        <div class="card-subtitle">Total recebido</div>
      </div>
    </div>

    <div class="info-card expense-card">
      <div class="card-icon bg-danger-light">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div class="card-content">
        <div class="card-title">GASTOS TOTAIS</div>
        <div class="card-value">{{ getDisplayValue(financialData.totalExpenseFormatted) }}</div>
        <div class="card-subtitle">{{ getExpensePercentage() }}% das entradas</div>
      </div>
    </div>
  </div>

  <!-- Seção de Conteúdo -->
  <div class="content-section">
    <!-- Filtros -->
    <div class="filters-panel">
      <div class="panel-header">
        <h3><i class="fas fa-filter"></i> Filtros Avançados</h3>
        <p class="panel-description">Configure os filtros para visualizar suas transações</p>
      </div>

      <div class="filters-grid">
        <!-- Primeira linha - Filtros básicos -->
        <div class="filter-item">
          <label><i class="fas fa-clock"></i> Status:</label>
          <select [(ngModel)]="selectedStatus" (change)="updateFinancialData()" class="filter-select">
            <option value="ALL">Todos os status</option>
            <option [value]="PaymentStatus.PENDING">Pendente</option>
            <option [value]="PaymentStatus.PAID">Pago</option>
            <option [value]="PaymentStatus.FAILED">Falhado</option>
          </select>
        </div>

        <div class="filter-item">
          <label><i class="fas fa-exchange-alt"></i> Tipo:</label>
          <select [(ngModel)]="selectedTransactionType" (change)="updateFinancialData()" class="filter-select">
            <option value="">Todos os tipos</option>
            <option [value]="'INCOME'">Receitas</option>
            <option [value]="'EXPENSE'">Despesas</option>
          </select>
        </div>

        <div class="filter-item">
          <label><i class="fas fa-tags"></i> Categoria:</label>
          <select [(ngModel)]="selectedCategoryId" (change)="updateFinancialData()" class="filter-select">
            <option value="">Todas as categorias</option>
            <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
          </select>
        </div>

        <!-- Seletor de Contas -->
        <div class="filter-item account-selector-container">
          <label><i class="fas fa-university"></i> Contas:</label>
          <div class="account-selector-wrapper">
            <button type="button"
                    class="account-selector-button"
                    (click)="toggleAccountSelector()"
                    [class.active]="showAccountSelector">
              <span class="selector-text">{{ getSelectedAccountsLabel() }}</span>
              <i class="fas fa-chevron-down" [class.rotated]="showAccountSelector"></i>
            </button>

            <!-- Dropdown de Contas -->
            <div class="account-dropdown" *ngIf="showAccountSelector" (click)="$event.stopPropagation()">
              <div class="dropdown-header">
                <label class="account-option">
                  <input type="checkbox"
                         [checked]="allAccountsSelected"
                         (change)="toggleAllAccounts()"
                         class="account-checkbox">
                  <span class="account-name">
                    <i class="fas fa-check-double"></i>
                    Todas as contas
                  </span>
                </label>
              </div>

              <div class="dropdown-separator"></div>

              <div class="accounts-list" *ngIf="!isLoadingAccounts">
                <label class="account-option" *ngFor="let account of accounts">
                  <input type="checkbox"
                         [checked]="isAccountSelected(account.accountId)"
                         (change)="toggleAccountSelection(account.accountId)"
                         class="account-checkbox">
                  <span class="account-info">
                    <i [class]="getAccountTypeIcon(account.accountType)"></i>
                    <span class="account-details">
                      <span class="account-name">{{ account.accountName }}</span>
                      <span class="account-type">{{ account.accountType }}</span>
                      <span class="account-balance"
                            *ngIf="account.accountType !== AccountType.CARTAO_CREDITO">
                        {{ getDisplayValue(account.accountCurrentBalanceFormatted) }}
                      </span>
                      <span class="account-limit"
                            *ngIf="account.accountType === AccountType.CARTAO_CREDITO && account.accountCreditLimitFormatted">
                        Limite: {{ getDisplayValue(account.accountCreditLimitFormatted) }}
                      </span>
                    </span>
                  </span>
                </label>
              </div>

              <div class="loading-accounts" *ngIf="isLoadingAccounts">
                <i class="fas fa-spinner fa-spin"></i>
                Carregando contas...
              </div>
            </div>
          </div>
        </div>

        <!-- Segunda linha - Filtros de data -->
        <div class="filter-item">
          <label><i class="fas fa-calendar-alt"></i> Data Inicial:</label>
          <input appBrazilianDate [(ngModel)]="startDate" (change)="updateFinancialData()" class="filter-input"
                 placeholder="dd/mm/aaaa">
        </div>

        <div class="filter-item">
          <label><i class="fas fa-calendar-check"></i> Data Final:</label>
          <input appBrazilianDate [(ngModel)]="endDate" (change)="updateFinancialData()" class="filter-input"
                 placeholder="dd/mm/aaaa">
        </div>

        <!-- Terceira linha - Filtros avançados -->
        <div class="filter-item">
          <label><i class="fas fa-search"></i> Descrição:</label>
          <input [(ngModel)]="selectedDescription" (keyup.enter)="updateFinancialData()" (blur)="updateFinancialData()"
                 class="filter-input" placeholder="Buscar por descrição...">
        </div>

        <div class="filter-item">
          <label><i class="fas fa-repeat"></i> Recorrente:</label>
          <select [(ngModel)]="selectedIsRecurring" (change)="updateFinancialData()" class="filter-select">
            <option value="">Todos</option>
            <option [value]="true">Sim</option>
            <option [value]="false">Não</option>
          </select>
        </div>

        <div class="filter-item">
          <label><i class="fas fa-layer-group"></i> Parcelado:</label>
          <select [(ngModel)]="selectedHasInstallments" (change)="updateFinancialData()" class="filter-select">
            <option value="">Todos</option>
            <option [value]="true">Sim</option>
            <option [value]="false">Não</option>
          </select>
        </div>

        <!-- Quarta linha - Filtros de valor -->
        <div class="filter-item">
          <label><i class="fas fa-coins"></i> Valor Mínimo:</label>
          <input type="number" [(ngModel)]="selectedMinAmount" (change)="updateFinancialData()"
                 class="filter-input" placeholder="R$ 0,00" min="0" step="0.01">
        </div>

        <div class="filter-item">
          <label><i class="fas fa-coins"></i> Valor Máximo:</label>
          <input type="number" [(ngModel)]="selectedMaxAmount" (change)="updateFinancialData()"
                 class="filter-input" placeholder="R$ 999.999,99" min="0" step="0.01">
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn-reset" (click)="resetToCurrentMonth()">
          <i class="fas fa-refresh"></i>
          Resetar Filtros
        </button>

        <!-- Resumo dos Filtros -->
        <div class="filter-summary">
          <div class="summary-item">
            <i class="fas fa-info-circle"></i>
            <span class="summary-label">Status:</span>
            <span class="summary-value">{{ getStatusLabel(selectedStatus) }}</span>
          </div>
          <div class="summary-item">
            <i class="fas fa-calendar-range"></i>
            <span class="summary-label">Período:</span>
            <span class="summary-value">{{ formatDateRange() }}</span>
          </div>
          <div class="summary-item">
            <i class="fas fa-university"></i>
            <span class="summary-label">Contas:</span>
            <span class="summary-value">{{ getSelectedAccountsLabel() }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de Transações -->
    <div class="transactions-section">
      <div class="section-header">
        <div class="section-title-group">
          <h3><i class="fas fa-list"></i> Histórico de Transações</h3>
          <p class="section-description">Visualize e gerencie suas transações financeiras</p>
        </div>
        <div class="section-controls">
          <div class="control-group">
            <label>Itens por página:</label>
            <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingTransactions" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Carregando transações...</p>
      </div>

      <!-- Tabela de Transações -->
      <div *ngIf="!isLoadingTransactions && transactions.length > 0" class="transactions-table-container">
        <table class="transactions-table">
          <thead>
          <tr>
            <th><i class="fas fa-align-left"></i> Descrição</th>
            <th><i class="fas fa-tags"></i> Categoria</th>
            <th><i class="fas fa-coins"></i> Valor</th>
            <th><i class="fas fa-info"></i> Tipo</th>
            <th><i class="fas fa-calendar"></i> Vencimento</th>
            <th><i class="fas fa-check-circle"></i> Status</th>
            <th><i class="fas fa-cog"></i> Ações</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let transaction of transactions"
              [class]="'transaction-row ' + (transaction.type === TransactionType.INCOME ? 'income-row' : 'expense-row')">

            <td class="description-cell">
              <div class="transaction-description">
                  <span class="main-description clickable" (click)="viewTransactionDetails(transaction)">
                    {{ transaction.description }}
                  </span>
                <span *ngIf="transaction.notes" class="transaction-notes">
                    {{ transaction.notes }}
                  </span>
              </div>
            </td>

            <td class="category-cell">
              <span class="category-name">{{ transaction.categoryName || 'Sem categoria' }}</span>
            </td>

            <td class="amount-cell">
              <div class="amount-value"
                   [class.income-amount]="transaction.type === TransactionType.INCOME && transaction.status === 'PAID'"
                   [class.expense-amount]="transaction.type === TransactionType.EXPENSE && transaction.status === 'PAID'"
                   [class.pending-amount]="transaction.status === 'PENDING'"
                   [class.failed-amount]="transaction.status === 'FAILED'">
                {{ getDisplayValue(transaction.amountFormatted) }}
              </div>
              <div *ngIf="transaction.installmentInfo" class="installment-info">
                {{ transaction.installmentInfo.currentInstallment }}/{{ transaction.installmentInfo.totalInstallments }}
              </div>
            </td>

            <td class="type-cell">
                <span class="transaction-type-badge" [class]="getTransactionTypeBadgeClass(transaction)">
                  {{ getTransactionTypeLabel(transaction) }}
                </span>
            </td>

            <td class="date-cell">
              {{ formatDate(transaction.dueDate) }}
            </td>

            <td class="status-cell">
                <span class="status-text" [class]="'status-' + transaction.status.toLowerCase()">
                  {{ getStatusLabel(transaction.status) }}
                </span>
            </td>

            <!-- Ações -->
            <td class="actions-cell">
              <button class="btn-action btn-edit" (click)="editTransaction(transaction)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-action btn-delete" (click)="confirmDeleteTransaction(transaction)">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Layout Mobile em Cards (escondido no desktop) -->
      <div *ngIf="!isLoadingTransactions && transactions.length > 0" class="transactions-mobile-layout">
        <div *ngFor="let transaction of transactions"
             class="transaction-card"
             [class.income-card]="transaction.type === TransactionType.INCOME"
             [class.expense-card]="transaction.type === TransactionType.EXPENSE">

          <!-- Header do Card -->
          <div class="transaction-card-header">
            <div class="transaction-card-main">
              <div class="transaction-card-title" (click)="viewTransactionDetails(transaction)">
                {{ transaction.description }}
              </div>
              <div class="transaction-card-amount"
                   [class.income-amount]="transaction.type === TransactionType.INCOME && transaction.status === 'PAID'"
                   [class.expense-amount]="transaction.type === TransactionType.EXPENSE && transaction.status === 'PAID'"
                   [class.pending-amount]="transaction.status === 'PENDING'"
                   [class.failed-amount]="transaction.status === 'FAILED'">
                {{ getDisplayValue(transaction.amountFormatted) }}
              </div>
            </div>
            <div class="transaction-card-type"
                 [class.income-type]="transaction.type === TransactionType.INCOME"
                 [class.expense-type]="transaction.type === TransactionType.EXPENSE">
              {{ getTransactionTypeLabel(transaction) }}
            </div>
          </div>

          <!-- Parcelas (se existir) -->
          <div *ngIf="transaction.installmentInfo" class="transaction-card-installment">
            <i class="fas fa-credit-card"></i>
            {{ transaction.installmentInfo.currentInstallment }}/{{ transaction.installmentInfo.totalInstallments }}
          </div>

          <!-- Detalhes do Card -->
          <div class="transaction-card-details">
            <div class="transaction-card-detail">
              <div class="transaction-card-detail-label">Categoria</div>
              <div class="transaction-card-detail-value">
                {{ transaction.categoryName || 'Sem categoria' }}
              </div>
            </div>

            <div class="transaction-card-detail">
              <div class="transaction-card-detail-label">Vencimento</div>
              <div class="transaction-card-detail-value">
                {{ formatDate(transaction.dueDate) }}
              </div>
            </div>

            <div class="transaction-card-detail">
              <div class="transaction-card-detail-label">Status</div>
              <div class="transaction-card-status"
                   [class]="'status-' + transaction.status.toLowerCase()">
                {{ getStatusLabel(transaction.status) }}
              </div>
            </div>
          </div>

          <!-- Notas (se existir) -->
          <div *ngIf="transaction.notes" class="transaction-card-notes">
            <i class="fas fa-sticky-note"></i>
            {{ transaction.notes }}
          </div>

          <!-- Ações do Card -->
          <div class="transaction-card-actions">
            <button class="transaction-card-action edit-action"
                    (click)="editTransaction(transaction)">
              <i class="fas fa-edit"></i>
              Editar
            </button>
            <button class="transaction-card-action delete-action"
                    (click)="confirmDeleteTransaction(transaction)">
              <i class="fas fa-trash"></i>
              Excluir
            </button>
          </div>
        </div>
      </div>

      <!-- Estado Vazio -->
      <div *ngIf="!isLoadingTransactions && transactions.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-inbox"></i>
        </div>
        <h3>Nenhuma transação encontrada</h3>
        <p>Não há transações para os filtros selecionados. Tente ajustar os filtros ou adicionar novas transações.</p>
        <div class="empty-actions">
          <button class="btn-action btn-income" (click)="openIncomeModal()">
            <i class="fas fa-plus"></i>
            Nova Receita
          </button>
          <button class="btn-action btn-expense" (click)="openExpenseModal()">
            <i class="fas fa-plus"></i>
            Nova Despesa
          </button>
        </div>
      </div>

      <!-- Paginação -->
      <div *ngIf="!isLoadingTransactions && transactions.length > 0" class="pagination-container">
        <div class="pagination-info">
          Mostrando {{ getDisplayRange() }} de {{ totalElements }} transações
        </div>

        <div class="pagination-controls">
          <!-- Primeira página -->
          <button
            class="pagination-btn"
            [disabled]="currentPage === 0"
            (click)="goToPage(0)">
            <i class="fas fa-angle-double-left"></i>
          </button>

          <!-- Página anterior -->
          <button
            class="pagination-btn"
            [disabled]="currentPage === 0"
            (click)="goToPage(currentPage - 1)">
            <i class="fas fa-angle-left"></i>
          </button>

          <!-- Páginas numeradas -->
          <div class="pagination-pages">
            <button
              *ngFor="let page of getVisiblePages()"
              class="pagination-btn"
              [class.active]="page === currentPage"
              (click)="goToPage(page)">
              {{ page + 1 }}
            </button>
          </div>

          <!-- Próxima página -->
          <button
            class="pagination-btn"
            [disabled]="currentPage >= totalPages - 1"
            (click)="goToPage(currentPage + 1)">
            <i class="fas fa-angle-right"></i>
          </button>

          <!-- Última página -->
          <button
            class="pagination-btn"
            [disabled]="currentPage >= totalPages - 1"
            (click)="goToPage(totalPages - 1)">
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Transação -->
  <app-transaction-modal
    (transactionCreated)="onTransactionCreated()"
    (transactionUpdated)="onTransactionUpdated()"
  ></app-transaction-modal>

  <!-- Modal de Categoria -->
  <app-category-modal
    (categoryCreated)="onCategoryChanged()"
    (categoryUpdated)="onCategoryChanged()"
  ></app-category-modal>

  <!-- Modal de Detalhes da Transação -->
  <app-transaction-detail-modal
    (editRequested)="onEditFromDetails($event)"
    (deleteRequested)="onDeleteFromDetails($event)"
  ></app-transaction-detail-modal>

  <!-- Onboarding Tooltip -->
  <app-onboarding-tooltip
    [visible]="showOnboardingTooltip"
    [tooltip]="currentOnboardingTooltip!"
    (nextStep)="onTooltipNext()"
    (skipTour)="onTooltipSkip()"
    (closeTour)="onTooltipClose()"
  ></app-onboarding-tooltip>
</div>
